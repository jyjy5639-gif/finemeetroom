<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>회의실 예약 시스템</title>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- ══ SETUP SCREEN ══════════════════════════════════════════ -->
<div id="setupScreen">
  <div class="setup-box">
    <div class="setup-logo">MEETROOM / SETUP</div>
    <div class="setup-title">Supabase 연결 설정</div>
    <div class="setup-desc">처음 한 번만 설정하면 이후에는 자동으로 연결됩니다.<br>아래 순서대로 진행해주세요.</div>
    <div class="setup-step">
      <div class="step-num">1</div>
      <div class="step-text"><a href="https://supabase.com" target="_blank">supabase.com</a> 에서 무료 계정 생성 후 새 프로젝트를 만드세요.</div>
    </div>
    <div class="setup-step">
      <div class="step-num">2</div>
      <div class="step-text">프로젝트 생성 후 <strong>SQL Editor</strong> 메뉴에서 아래 SQL을 실행하세요.</div>
    </div>
    <div class="sql-block">CREATE TABLE reservations (
  id         bigserial PRIMARY KEY,
  room_idx   integer NOT NULL,
  date       text NOT NULL,
  start_time text NOT NULL,
  end_time   text NOT NULL,
  dept       text NOT NULL,
  name       text NOT NULL,
  purpose    text NOT NULL,
  created_at timestamptz DEFAULT now()
);
ALTER TABLE reservations ENABLE ROW LEVEL SECURITY;
CREATE POLICY "allow_all" ON reservations FOR ALL USING (true) WITH CHECK (true);</div>
    <div class="setup-step">
      <div class="step-num">3</div>
      <div class="step-text"><strong>Project Settings → API</strong> 에서 <code>Project URL</code>과 <code>anon public key</code>를 복사해서 아래에 붙여넣으세요.</div>
    </div>
    <hr class="setup-divider">
    <label class="setup-input-label">Supabase Project URL</label>
    <input class="setup-input" id="cfgUrl" placeholder="https://xxxxxxxxxxxx.supabase.co" autocomplete="off">
    <label class="setup-input-label">Supabase Anon Key</label>
    <input class="setup-input" id="cfgKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." autocomplete="off">
    <button class="setup-btn" id="setupBtn" onclick="saveConfig()">연결 확인 및 시작</button>
    <div class="setup-error" id="setupError"></div>
  </div>
</div>

<!-- ══ APP ══════════════════════════════════════════════════ -->
<header class="header" style="display:none" id="appHeader">
  <div class="header-logo"><div class="logo-pip"></div>화인파트너스 MEETROOM</div>
  <nav class="header-nav">
    <button class="nav-tab active" onclick="switchPage('grid')">타임 그리드</button>
    <button class="nav-tab" onclick="switchPage('list')">예약 목록</button>
    <button class="nav-tab" onclick="authThen(()=>switchPage('admin'))">⚙ 관리</button>
  </nav>
  <div class="header-right">
    <div class="sync-badge" onclick="loadData()" title="클릭하여 새로고침">
      <div class="sync-dot" id="syncDot"></div>
      <span id="syncLabel">연결 중...</span>
    </div>
    <div class="header-date" id="hDate"></div>
    <button class="btn-settings" onclick="authThen(resetConfig)">⚙ 설정</button>
  </div>
</header>

<div class="layout" style="display:none" id="appLayout">
  <aside class="sidebar">
    <div class="sb-section">
      <div class="sb-label">회의실</div>
      <div class="room-item active" id="ri-all" onclick="setRoomFilter('all')">
        <div class="ri-dot" style="background:#1a1917"></div>
        <div style="flex:1"><div class="ri-name">전체 보기</div></div>
      </div>
      <div id="sidebarRooms"></div>
    </div>
    <div class="mini-cal">
      <div class="mc-header">
        <button class="mc-arrow" onclick="calMove(-1)">←</button>
        <span class="mc-title" id="mcTitle"></span>
        <button class="mc-arrow" onclick="calMove(1)">→</button>
      </div>
      <div class="mc-grid" id="mcGrid"></div>
    </div>
  </aside>

  <!-- 모바일 날짜 네비게이션 -->
  <div class="mobile-date-nav" id="mobileDateNav" style="display:none">
    <button class="mdn-btn" onclick="mobileDateMove(-1)">←</button>
    <div class="mdn-center">
      <div class="mdn-date" id="mdnDate"></div>
      <div class="mdn-day" id="mdnDay"></div>
      <div class="mdn-today" onclick="mobileDateToday()">오늘로</div>
    </div>
    <button class="mdn-btn" onclick="mobileDateMove(1)">→</button>
  </div>

  <main class="main">
    <div class="view-bar">
      <div>
        <div class="view-title" id="viewTitle"></div>
        <div class="view-sub">09:00–18:00 운영 · 30분 단위 · <span style="color:#2ab87a;font-weight:600;">Supabase 실시간 공유</span></div>
      </div>
      <div class="view-controls">
        <button class="btn-reserve" onclick="openModal()">＋ 예약하기</button>
      </div>
    </div>
    <div class="overview-grid" id="overviewGrid"></div>
    <div id="pagGrid">
      <div class="grid-wrap"><div class="grid-scroll">
        <table class="time-table" id="timeTable"></table>
      </div></div>
    </div>
    <div id="pagList" style="display:none">
      <div class="list-filters" id="listFilters"></div>
      <table class="list-table">
        <thead><tr>
          <th>회의실</th><th>날짜</th><th>시간</th><th>부서</th><th>예약자</th><th>목적</th><th>등록일시</th><th></th>
        </tr></thead>
        <tbody id="listBody"></tbody>
      </table>
    </div>
    <div id="pagAdmin" style="display:none">
      <div style="max-width:720px">
        <div class="admin-section-title">회의실 관리</div>
        <div class="admin-section-sub">회의실 이름, 수용 인원, 색상을 변경할 수 있습니다.</div>
        <div class="room-editor-list" id="roomEditorList"></div>
        <button class="btn-add-room" onclick="addRoomEditor()">＋ 회의실 추가</button>
        <div class="admin-save-bar" style="margin-top:20px">
          <button class="btn-save-rooms" onclick="saveRooms()">회의실 저장</button>
          <span class="save-feedback" id="roomSaveFeedback">✅ 저장되었습니다</span>
        </div>
        <hr class="admin-divider">
        <div class="admin-section-title">부서 목록 관리</div>
        <div class="admin-section-sub">예약 시 선택 가능한 부서 목록을 편집합니다.</div>
        <div class="dept-editor-list" id="deptEditorList"></div>
        <button class="btn-add-room" onclick="addDeptEditor()" style="margin-bottom:0">＋ 부서 추가</button>
        <div class="admin-save-bar">
          <button class="btn-save-rooms" onclick="saveDepts()">부서 저장</button>
          <span class="save-feedback" id="deptSaveFeedback">✅ 저장되었습니다</span>
        </div>
        <hr class="admin-divider">
        <div class="admin-section-title">Supabase 연결 재설정</div>
        <div class="admin-section-sub" style="margin-bottom:12px">연결 정보를 초기화하고 다시 설정합니다.</div>
        <button class="btn-ghost" onclick="resetConfig()" style="color:#e8522a;border-color:#e8522a">연결 초기화</button>
      </div>
    </div>
  </main>
</div>

<!-- 예약 모달 -->
<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">회의실 예약</div>
      <button class="modal-close" onclick="closeModal()">✕</button>
    </div>
    <div class="info-pill">🏢 <span id="infoPillText">회의실과 시간을 선택해주세요</span></div>
    <div class="conflict-warning" id="conflictWarn">⚠️ 해당 시간에 이미 예약이 있습니다.</div>
    <div class="form-row">
      <div class="form-col"><label>회의실 *</label>
        <select id="fRoom" onchange="onFormChange()">
          <option value="">선택</option>
        </select>
      </div>
      <div class="form-col"><label>날짜 *</label><input type="date" id="fDate" onchange="onFormChange()"></div>
    </div>
    <div class="form-row">
      <div class="form-col"><label>시작 시간 *</label><select id="fStart" onchange="onStartChange()"></select></div>
      <div class="form-col"><label>종료 시간 *</label><select id="fEnd" onchange="checkConflict()"></select></div>
    </div>
    <div class="form-row">
      <div class="form-col"><label>부서 *</label>
        <select id="fDept"><option value="">선택</option></select>
      </div>
      <div class="form-col"><label>예약자 *</label><input type="text" id="fName" placeholder="홍길동"></div>
    </div>
    <div class="form-full">
      <div style="margin-bottom:5px"><label>사용 목적 *</label></div>
      <textarea id="fPurpose" placeholder="예: 팀 주간 회의, 투자심의위원회, 외부 미팅..."></textarea>
    </div>
    <div class="form-full">
      <div style="margin-bottom:5px"><label>이메일 <span style="color:var(--text-dim);font-size:10px;text-transform:none;font-weight:400;">(예약 확인 메일 수신 · 선택)</span></label></div>
      <div id="emailContainer" style="display:flex;flex-direction:column;gap:8px;"></div>
      <button type="button" class="btn-add-room" onclick="addEmailInput()" style="margin-top:8px">＋ 이메일 추가</button>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" onclick="closeModal()">취소</button>
      <button class="btn-confirm" id="btnConfirm" onclick="submitForm()">예약 확정</button>
    </div>
  </div>
</div>

<!-- 예약 상세 모달 -->
<div class="overlay" id="detailOverlay">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">예약 정보</div>
      <button class="modal-close" onclick="closeDetailModal()">✕</button>
    </div>
    <div class="detail-room-bar" id="detailRoomBar"></div>
    <div class="detail-grid">
      <div class="detail-label">날짜</div><div class="detail-val" id="detailDate"></div>
      <div class="detail-label">시간</div><div class="detail-val" id="detailTime"></div>
      <div class="detail-label">부서</div><div class="detail-val" id="detailDept"></div>
      <div class="detail-label">예약자</div><div class="detail-val" id="detailName"></div>
      <div class="detail-label">목적</div><div class="detail-val" id="detailPurpose"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" onclick="closeDetailModal()">닫기</button>
      <button class="btn-ghost" id="btnEditRes" onclick="openEditModal(detailResId)" style="color:#2a7ae8;border-color:#2a7ae8">예약 수정</button>
      <button class="btn-cancel-confirm" id="btnCancelRes" onclick="cancelFromDetail()">예약 취소</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"><span id="toastIcon"></span><span id="toastMsg"></span></div>

<!-- 모바일 하단 탭바 -->
<div class="mobile-tabbar">
  <button class="mobile-tab active" id="mtab-grid" onclick="switchPage('grid')">
    <span class="mobile-tab-icon">📅</span>그리드
  </button>
  <button class="mobile-tab" id="mtab-list" onclick="switchPage('list')">
    <span class="mobile-tab-icon">📋</span>목록
  </button>
  <button class="mobile-tab" onclick="openModal()">
    <span class="mobile-tab-add">＋</span>
  </button>
  <button class="mobile-tab" id="mtab-admin" onclick="authThen(()=>switchPage('admin'))">
    <span class="mobile-tab-icon">⚙️</span>관리
  </button>
</div>

<script src="config.js"></script>
<script src="app.js"></script>
</body>
</html>
